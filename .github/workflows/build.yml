name: Build SakuOS ISO
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y live-build squashfs-tools xorriso debootstrap

      - name: Setup and Build
        run: |
          mkdir -p build && cd build
          
          # Initialize configuration
          lb config --architecture amd64 \
                    --distribution bookworm \
                    --binary-images iso-hybrid \
                    --debian-installer live \
                    --archive-areas "main contrib non-free non-free-firmware" \
                    --memtest none \
                    --apt-indices false

          # 1. Tambahkan paket esensial (Pasti ada di PC)
          echo "task-xfce-desktop lightdm network-manager sudo xterm" > config/package-lists/desktop.list.chroot

          # 2. Ekstrak desain SakuOS lu
          # Kita gunakan try-catch agar jika ada file path aneh tidak langsung stop
          mkdir -p config/includes.chroot/
          if [ -f ../sakuos_all_in.tar.gz ]; then
            sudo tar -xvzf ../sakuos_all_in.tar.gz -C config/includes.chroot/ || echo "Warning: Some files failed to extract"
          fi

          # 3. Fix User Pelajar (Biar gak bentrok)
          mkdir -p config/hooks/live
          cat <<EOF > config/hooks/live/01-setup-user.chroot
          #!/bin/sh
          useradd -m -s /bin/bash pelajar || true
          echo "pelajar:pelajar" | chpasswd
          usermod -aG sudo pelajar || true
          EOF
          chmod +x config/hooks/live/01-setup-user.chroot

          # 4. MULAI RAKIT DENGAN LOG
          sudo lb build 2>&1 | tee build.log

      - name: Upload ISO
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: SakuOS-ISO
          path: build/*.iso

      - name: Upload Error Log (Kalau Gagal)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: Build-Log-Gagal
          path: build/build.log
          
