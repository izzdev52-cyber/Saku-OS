name: Build SakuOS ISO
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Build Tools
        run: |
          sudo apt update
          sudo apt install -y live-build squashfs-tools xorriso debootstrap

      - name: Setup and Build
        run: |
          # 1. Inisialisasi Konfigurasi
          lb config --architecture amd64 \
                    --distribution bookworm \
                    --binary-images iso-hybrid \
                    --debian-installer live \
                    --archive-areas "main contrib non-free non-free-firmware" \
                    --memtest none

          # 2. Tambah Aplikasi Utama (GUI XFCE)
          echo "task-xfce-desktop lightdm network-manager sudo xterm firefox-esr" > config/package-lists/desktop.list.chroot

          # 3. Masukkan Jiwa SakuOS (Settingan dari Termux)
          mkdir -p config/includes.chroot/
          if [ -f sakuos_all_in.tar.gz ]; then
            sudo tar -xvzf sakuos_all_in.tar.gz -C config/includes.chroot/ --overwrite || echo "Skala kecil berhasil"
          fi

          # 4. Buat User 'pelajar' & Password Otomatis
          mkdir -p config/hooks/live
          cat <<EOF > config/hooks/live/01-setup-user.chroot
          #!/bin/sh
          useradd -m -s /bin/bash pelajar || true
          echo "pelajar:pelajar" | chpasswd
          usermod -aG sudo pelajar || true
          EOF
          chmod +x config/hooks/live/01-setup-user.chroot

          # 5. Eksekusi Pembuatan ISO
          sudo lb build

      - name: Prepare ISO for Release
        run: |
          find . -name "*.iso" -exec mv {} SakuOS-v1.iso \;

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v1.0.${{ github.run_number }}
          name: SakuOS Release v1.0.${{ github.run_number }}
          files: SakuOS-v1.iso
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
